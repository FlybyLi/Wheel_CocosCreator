{"version":3,"sources":["Wheel.js"],"names":["cc","Class","extends","Component","properties","spinBtn","default","type","Button","visible","displayName","wheelSp","Sprite","maxSpeed","Float","max","min","duration","tooltip","acc","targetID","Integer","springback","effectAudio","url","AudioClip","onLoad","log","wheelState","curSpeed","spinTime","gearNum","defaultAngle","gearAngle","node","rotation","finalAngle","effectFlag","sys","isBrowser","loader","loadRes","err","res","on","Node","EventType","TOUCH_END","event","decAngle","bind","start","caculateFinalAngle","editBoxDidBegin","edit","editBoxDidChanged","text","editBoxDidEndEditing","parseInt","string","isNaN","alert","Math","round","random","update","dt","audioID","audioEngine","playEffect","raw","curRo","hadRo","act","rotateBy","seq","sequence","delayTime","callFunc","showRes","runAction","Config","require","gearInfo"],"mappings":"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","file":"Wheel.js","sourceRoot":"../../../../assets/Script","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        spinBtn: {\n            default: null,      // The default value will be used only when the component attachin                    // to a node for the first time\n            type:cc.Button,     // optional, default is typeof default\n            visible: true,      // optional, default is true\n            displayName: 'SpinBtn', // optional\n        },\n        wheelSp:{\n            default:null,\n            type:cc.Sprite\n        },\n        maxSpeed:{\n            default:5,\n            type:cc.Float,\n            max:15,\n            min:2,\n        },\n        duration:{\n            default:3,\n            type:cc.Float,\n            max:5,\n            min:1,\n            tooltip:\"减速前旋转时间\"\n        },\n        acc:{\n            default:0.1,\n            type:cc.Float,\n            max:0.2,\n            min:0.01,\n            tooltip:\"加速度\"\n        },\n        targetID:{\n            default:0,\n            type:cc.Integer,\n            max:17,\n            min:0,\n            tooltip:\"指定结束时的齿轮\"\n        },\n        springback:{\n            default:false,\n            tooltip:\"旋转结束是否回弹\"\n        },\n        effectAudio:{\n            default:null,\n            url:cc.AudioClip\n        }\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        cc.log(\"....onload\");\n        this.wheelState = 0;    \n        this.curSpeed = 0;\n        this.spinTime = 0;                   //减速前旋转时间\n        this.gearNum = 18;\n        this.defaultAngle = 360/18/2;        //修正默认角度\n        this.gearAngle = 360/this.gearNum;   //每个齿轮的角度\n        this.wheelSp.node.rotation = this.defaultAngle;\n        this.finalAngle = 0;                 //最终结果指定的角度\n        this.effectFlag = 0;                 //用于音效播放\n        \n        if(!cc.sys.isBrowser)\n        {\n            cc.loader.loadRes('Sound/game_turntable', function(err,res){if(err){cc.log('...err:'+err);}});\n        }\n        this.spinBtn.node.on(cc.Node.EventType.TOUCH_END,function(event)\n        {\n            cc.log(\"begin spin\");\n            if(this.wheelState !== 0)\n            {\n                 return;\n            }\n            this.decAngle = 2*360;  // 减速旋转两圈\n            this.wheelState = 1;\n            this.curSpeed = 0;\n            this.spinTime = 0;\n            // var act = cc.rotateTo(10, 360*10);\n            // this.wheelSp.node.runAction(act.easing(cc.easeSineInOut()));\n        }.bind(this));\n    },\n\n    start:function()\n    {\n        // cc.log('....start');\n    },\n    \n    caculateFinalAngle:function(targetID)\n    {\n        this.finalAngle = 360-this.targetID*this.gearAngle + this.defaultAngle;\n        if(this.springback)\n        {\n            this.finalAngle += this.gearAngle;\n        }\n    },\n    editBoxDidBegin:function(edit)\n    {\n    },\n    editBoxDidChanged:function(text)\n    {\n    },\n    editBoxDidEndEditing:function(edit)\n    {\n        var res = parseInt(edit.string);\n        if(isNaN(res))\n        {\n            if(cc.sys.isBrowser)\n            {\n                alert('please input a number!');\n            }else cc.log(\".....invalid input\");\n            this.targetID = Math.round(Math.random()*(this.gearNum-1));\n            return;\n        }\n        this.targetID = res;\n    },\n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        if(this.wheelState === 0)\n        {\n            return;\n        }\n        // cc.log('......update');\n        // cc.log('......state=%d',this.wheelState);\n       \n        // 播放音效有可能卡\n        this.effectFlag += this.curSpeed;\n        if(!cc.sys.isBrowser && this.effectFlag >= this.gearAngle)\n        {\n            if(this.audioID)\n            {\n                // cc.audioEngine.pauseEffect(this.audioID);\n            }\n            // this.audioID = cc.audioEngine.playEffect(this.effectAudio,false);\n            this.audioID = cc.audioEngine.playEffect(cc.url.raw('resources/Sound/game_turntable.mp3'));\n            this.effectFlag = 0;\n        }\n\n        if(this.wheelState == 1)\n        {\n            // cc.log('....加速,speed:' + this.curSpeed);\n            this.spinTime += dt;\n            this.wheelSp.node.rotation = this.wheelSp.node.rotation + this.curSpeed;\n            if(this.curSpeed <= this.maxSpeed)\n            {\n                this.curSpeed += this.acc;\n            }\n            else\n            {\n                if(this.spinTime<this.duration)\n                {\n                    return;\n                }\n                // cc.log('....开始减速');\n                //设置目标角度\n                this.finalAngle = 360-this.targetID*this.gearAngle + this.defaultAngle;\n                this.maxSpeed = this.curSpeed;\n                if(this.springback)\n                {\n                    this.finalAngle += this.gearAngle;\n                }\n                this.wheelSp.node.rotation = this.finalAngle;\n                this.wheelState = 2;\n            }\n        }\n        else if(this.wheelState == 2)\n        {\n            // cc.log('......减速');\n            var curRo = this.wheelSp.node.rotation; //应该等于finalAngle\n            var hadRo = curRo - this.finalAngle;\n            this.curSpeed = this.maxSpeed*((this.decAngle-hadRo)/this.decAngle) + 0.2; \n            this.wheelSp.node.rotation = curRo + this.curSpeed;\n\n            if((this.decAngle-hadRo)<=0)\n            {  \n                // cc.log('....停止');\n                this.wheelState = 0;\n                this.wheelSp.node.rotation = this.finalAngle;\n                if(this.springback)\n                {\n                    //倒转一个齿轮\n                    // var act = new cc.rotateBy(0.6, -this.gearAngle);\n                    var act = cc.rotateBy(0.6, -this.gearAngle);\n                    var seq = cc.sequence(cc.delayTime(0.2),act,cc.callFunc(this.showRes, this));\n                    this.wheelSp.node.runAction(seq);\n                }\n                else\n                {\n                    this.showRes();\n                }\n            }\n        }\n    },\n    showRes:function()\n    {\n        var Config = require(\"Config\");\n        if(cc.sys.isBrowser)\n        {\n            alert('You have got ' + Config.gearInfo[this.targetID]);\n        }\n        else cc.log(Config.gearInfo[this.targetID]);\n    }\n});\n"]}